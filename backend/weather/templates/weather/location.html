<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather & Geolocation</title>
    <style>
        .weather-box {
            border: 1px solid #ddd;
            padding: 15px;
            width: 300px;
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    
    <h2>Click the button to get your location and weather</h2>
    <button onclick="getLocation()">Get Weather</button>
    
    <p id="status"></p>
    
    <div id="weather" class="weather-box" style="display: none;">
        <h3 id="city"></h3>
        <p><strong>Temperature:</strong> <span id="temperature"></span>Â°C</p>
        <p><strong>Description:</strong> <span id="description"></span></p>
    </div>
    
    <br>
    
    <div id="activities" style="display: none;">
        <h3>Suggested Activities</h3>
        <ul id="activity"></ul>
    </div>
    
    <br>
    <div id="map" style="width: 600px; height: 400px;"></div>
    
    <!-- <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap" async defer></script> -->
    <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places&callback=initMap" async defer></script>
    
    <script>
    let map;
function initMap() {
    const lat = parseFloat(localStorage.getItem('lat'));
    const lng = parseFloat(localStorage.getItem('lng'));
    
    if (!lat || !lng) {
        console.error("User location not found in localStorage.");
        return;
    }

    const userLocation = { lat, lng };
    
    map = new google.maps.Map(document.getElementById("map"), {
        center: userLocation,
        zoom: 12,
    });

    new google.maps.Marker({
        position: userLocation,
        map: map,
        title: "Your Location",
    });
}

function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(sendPosition, showError);
    } else {
        document.getElementById("status").innerHTML = "Geolocation is not supported by this browser.";
    }
}

function sendPosition(position) {
    let latitude = position.coords.latitude;
    let longitude = position.coords.longitude;

    localStorage.setItem("lat", latitude);
    localStorage.setItem("lng", longitude);

    document.getElementById("status").innerHTML = `Latitude: ${latitude}, Longitude: ${longitude}`;

    fetch('/get_weather/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ lat: latitude, lon: longitude })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "success") {
            displayWeather(data.weather);
            displayActivities(data.activities);
            initMap(); // Re-initialize map with updated location
        } else {
            document.getElementById("status").innerHTML = "Could not retrieve weather.";
        }
    })
    .catch(error => console.error('Error:', error));
}

function displayWeather(weather) {
    document.getElementById("weather").style.display = "block";
    document.getElementById("city").textContent = weather.city;
    document.getElementById("temperature").textContent = weather.temperature;
    document.getElementById("description").textContent = weather.description;
}

// function displayActivities(activities) {
//     document.getElementById("activities").style.display = "block";
//     const activityList = document.querySelector("#activity");
    
//     // Clear the previous list
//     activityList.innerHTML = '';

//     // Populate the list with activities and places
//     activities.forEach(activity => {
//         const listItem = document.createElement('li');
//     //     // Create a clickable link to search the place on Google Maps
//         const mapLink = document.createElement('a');
//         // mapLink.href = `https://www.google.com/maps/search/?q=${encodeURIComponent(activity.place)}`;
//         mapLink.href = 'https://maps.googleapis.com/maps/api/place/textsearch/json?query=${activity.place}&key={{ google_maps_api_key }}';
//         mapLink.target = "_blank";  // Open the link in a new tab
//         mapLink.textContent = `${activity.activity} at ${activity.place}`;
//         //  listItem.textContent = `${activity.activity} at ${activity.place}`;
//         listItem.appendChild(mapLink); // Append the link to the list item
//         activityList.appendChild(listItem);
//     });

// }



function searchPlace(placeName) {
    if (!map) {
        console.error("Map not initialized");
        return;
    }

    const service = new google.maps.places.PlacesService(map);
    const request = {
        query: placeName,
        fields: ['name', 'geometry', 'formatted_address']
    };

    service.findPlaceFromQuery(request, (results, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK && results) {
            const place = results[0];
            console.log("Place found:", place); // Debug log
            showDirections(place.geometry.location);
        } else {
            console.error("Place search failed:", status);
        }
    });
}

function showDirections(destination) {
    const directionsService = new google.maps.DirectionsService();
    const directionsRenderer = new google.maps.DirectionsRenderer();
    directionsRenderer.setMap(map);

    let origin = null;
    const lat = localStorage.getItem('lat');
    const lng = localStorage.getItem('lng');

    // Validate and parse latitude and longitude
    if (lat && lng) {
        const parsedLat = parseFloat(lat);
        const parsedLng = parseFloat(lng);

        if (!isNaN(parsedLat) && !isNaN(parsedLng) && 
            parsedLat >= -90 && parsedLat <= 90 &&
            parsedLng >= -180 && parsedLng <= 180) {
            origin = { lat: parsedLat, lng: parsedLng };
        } else {
            console.error("Invalid latitude or longitude from localStorage.");
            // Display error message to the user
            alert("Could not retrieve your location. Please try again.");
            return; // Stop execution if origin is invalid
        }
    } else {
        console.error("Latitude or longitude missing from localStorage.");
        // Display error message to the user
        alert("Could not retrieve your location. Please try again.");
        return; // Stop execution
    }


    const request = {
        origin: origin,
        destination: destination,
        travelMode: 'DRIVING'
    };

    directionsService.route(request, (result, status) => {
        if (status === 'OK') {
            directionsRenderer.setDirections(result);
        } else {
            console.error("Directions request failed:", status);
            // Display a user-friendly error message based on the status
            alert("Could not calculate directions. Please try again later.");
        }
    });
}


function displayActivities(activities) {
    document.getElementById("activities").style.display = "block";
    const activityList = document.querySelector("#activity");
    activityList.innerHTML = '';

    activities.forEach(activity => {
        const listItem = document.createElement('li');
        const mapLink = document.createElement('a');
        mapLink.href = "#";
        mapLink.textContent = `${activity.activity} at ${activity.place}`;
        mapLink.onclick = (e) => {
            e.preventDefault();
            console.log("Searching for place:", activity.place); // Debug log
            searchPlace(activity.place);
        };
        listItem.appendChild(mapLink);
        activityList.appendChild(listItem);
    });
}

// Function to get CSRF token for Django
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        let cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            let cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showError(error) {
    switch (error.code) {
        case error.PERMISSION_DENIED:
            document.getElementById("status").innerHTML = "User denied the request for Geolocation.";
            break;
        case error.POSITION_UNAVAILABLE:
            document.getElementById("status").innerHTML = "Location information is unavailable.";
            break;
        case error.TIMEOUT:
            document.getElementById("status").innerHTML = "The request to get user location timed out.";
            break;
        case error.UNKNOWN_ERROR:
            document.getElementById("status").innerHTML = "An unknown error occurred.";
            break;
    }
}
</script>

</body>
</html>
