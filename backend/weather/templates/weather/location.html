<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather & Geolocation</title>
    <style>
        .weather-box {
            border: 1px solid #ddd;
            padding: 15px;
            width: 300px;
            text-align: center;
            margin-top: 20px;
        }
        
    </style>
</head>
<body>
    
    <h2>Click the button to get your location and weather</h2>
    <button onclick="getLocation()">Get Weather</button>
    
    <p id="status"></p>
    
    <div id="weather" class="weather-box" style="display: none;">
        <h3 id="city"></h3>
        <p><strong>Temperature:</strong> <span id="temperature"></span>Â°C</p>
        <p><strong>Description:</strong> <span id="description"></span></p>
    </div>
    
    <br>
    
    <div id="activities" style="display: none;">
        <h3>Suggested Activities</h3>
        <ul id="activity"></ul>

        <button id="newSuggestionBtn" style="display:none;" onclick="requestNewSuggestion()">New Suggestion</button>
    </div>
    
    <br>
    <div id="map" style="width: 600px; height: 400px;"></div>
    
    <!-- <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap" async defer></script> -->
    <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places&callback=initMap" async defer></script>
    
    <script>
    let map;
function initMap() {
    const lat = parseFloat(localStorage.getItem('lat'));
    const lng = parseFloat(localStorage.getItem('lng'));
    
    if (!lat || !lng) {
        console.error("User location not found in localStorage.");
        return;
    }

    const userLocation = { lat, lng };
    
    map = new google.maps.Map(document.getElementById("map"), {
        center: userLocation,
        zoom: 12,
    });

    new google.maps.Marker({
        position: userLocation,
        map: map,
        title: "Your Location",
    });
}

function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(sendPosition, showError);
    } else {
        document.getElementById("status").innerHTML = "Geolocation is not supported by this browser.";
    }
}

function sendPosition(position) {
    let latitude = position.coords.latitude;
    let longitude = position.coords.longitude;

    localStorage.setItem("lat", latitude);
    localStorage.setItem("lng", longitude);

    document.getElementById("status").innerHTML = `Latitude: ${latitude}, Longitude: ${longitude}`;

    fetch('/get_weather/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ lat: latitude, lon: longitude })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "success") {
            displayWeather(data.weather);
            displayActivities(data.activities);
            initMap(); // Re-initialize map with updated location
        } else {
            document.getElementById("status").innerHTML = "Could not retrieve weather.";
        }
    })
    .catch(error => console.error('Error:', error));
}

function displayWeather(weather) {
    document.getElementById("weather").style.display = "block";
    document.getElementById("city").textContent = weather.city;
    document.getElementById("temperature").textContent = weather.temperature;
    document.getElementById("description").textContent = weather.description;
    updateWeather(weather);
}

function formatOpeningHours(openingHours) {
    if (!openingHours || !openingHours.weekday_text) return "Opening hours not available";

    const today = new Date().getDay(); // Sunday = 0, Monday = 1, ..., Saturday = 6
    return openingHours.weekday_text[today - 1] || "Opening hours not available"; 
}

function updateActivityInfo(placeName, openingHours) {
    const activityItems = document.querySelectorAll("#activity li");

    activityItems.forEach(item => {
        if (item.querySelector("a").textContent.includes(placeName)) {
            const hoursDiv = item.querySelector(".opening-hours");
            // hoursDiv.textContent = `Opening Hours: ${openingHours}`;
        }
    });
}

function dismissActivity(activityElement, activityName, placeName) {
    fetch('/get_new_suggestion/', {
        method: 'POST',
        body: JSON.stringify({ dismissed_activity: activityName, place: placeName }),
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        // console.log("New activities received:", data.new_activities); // Debugging

        if (data.new_activities) {
            let activityList = document.getElementById("activity");
            activityList.innerHTML = ''; // Clear previous activities
            // console.log("New activities:", data.new_activities); // Debug log
            data.new_activities.forEach(activity => {
                let newListItem = document.createElement("li");
                let newMapLink = document.createElement("a");
                newMapLink.href = "#";
                newMapLink.textContent = `${activity.activity} at ${activity.place}`;
                newMapLink.onclick = (e) => {
                    e.preventDefault();
                    searchPlace(activity.place);
                };

                newListItem.appendChild(newMapLink);
                activityList.appendChild(newListItem);
            });
        } else {
            console.log("No more suggestions available.");
            activityElement.textContent = "No more suggestions available.";
        }
    })
    .catch(error => console.error("Error fetching new suggestion:", error));
}

function requestNewSuggestion() {
    if (!selectedActivity) {
        console.error("No activity selected");
        return;
    }

    fetch('/get_new_suggestion/', {
        method: 'POST',
        body: JSON.stringify({ dismissed_activity: selectedActivity.activity, place: selectedActivity.place }),
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.new_activity) {
                displayActivities(data.new_activity); // Update UI with the new suggestions
                displayAnimatedActivities(data.new_activity); // Animate the new suggestions
        } else {
            alert("No more suggestions available.");
        }
    })
    .catch(error => console.error("Error fetching new suggestion:", error));
}
function createActivityCard(activity) {
    const card = document.createElement('div');
    card.classList.add('activity-card', 'animate-slide-in');
    
    card.innerHTML = `
        <div class="activity-header">
            <h3>${activity.activity}</h3>
            <span class="location-badge">${activity.place}</span>
        </div>
        <div class="activity-actions">
            <button class="btn-explore" onclick="searchPlace('${activity.place}')">
                Explore
            </button>
            <button class="btn-dismiss" onclick="dismissActivity(this, '${activity.activity}', '${activity.place}')">
                Dismiss
            </button>
        </div>
    `;

    return card;
}

function displayAnimatedActivities(activities) {
    const container = document.getElementById('activities');
    const activityList = document.getElementById('activity');
    activityList.innerHTML = '';

    activities.forEach(activity => {
        const activityCard = createActivityCard(activity);
        activityList.appendChild(activityCard);
    });

    container.style.display = 'block';
}

function getPlaceDetails(placeId, placeName) {
    const service = new google.maps.places.PlacesService(map);
    const request = {
        placeId: placeId,
        fields: ['name', 'formatted_address', 'opening_hours']
    };

    service.getDetails(request, (place, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK && place) {
            // console.log(`Details for ${placeName}:`, place); // Debug log

            const openingHours = place.opening_hours ? formatOpeningHours(place.opening_hours) : "Opening hours not available";
            // console.log(`Opening Hours for ${placeName}:`, openingHours); // Debug log
            
            updateActivityInfo(placeName, openingHours);
        } else {
            console.error("Place details not found:", status);
        }
    });
}

function searchPlace(placeName) {
    if (!map) {
        console.error("Map not initialized");
        return;
    }

    const service = new google.maps.places.PlacesService(map);
    const request = {
        query: placeName,
        fields: ['place_id', 'name', 'geometry', 'formatted_address']
    };
    
    service.findPlaceFromQuery(request, (results, status) => {
        // console.log("Place search status:", status); // Debug log
        if (status === google.maps.places.PlacesServiceStatus.OK && results) {
            const place = results[0];
            // console.log("Place found:", place); // Debug log
            // console.log("Place id:", place.place_id); // Debug log
            // console.log("Place found:", place); // Debug log
            if (place.geometry && place.geometry.location){
                const destination = place.geometry.location; // Extract location
                const destinationCoordinates = {
                    lat: destination.lat(),
                    lng: destination.lng()
                };
                getPlaceDetails(place.place_id, place.name);
                // console.log("Destination coordinates in searchplace funtion:", destinationCoordinates); //Debug log
                showDirections(destinationCoordinates);
            }
            else {
                console.error("Place geometry not found:", place);
            }
        } else {
            console.error("Place search failed:", status);
        }
    });
}

function showDirections(destination) {
    // console.log("showDirections called with destination:", destination);

    if (!map) {
        console.error("Map not initialized.");
        return;
    }

    const directionsService = new google.maps.DirectionsService();
    const directionsRenderer = new google.maps.DirectionsRenderer();
    directionsRenderer.setMap(map);

    const lat = localStorage.getItem('lat');
    const lng = localStorage.getItem('lng');

    if (!lat || !lng) {
        console.error("Origin coordinates not found in localStorage.");
        alert("Could not retrieve your location. Please try again.");
        return;
    }

    const origin = { lat: parseFloat(lat), lng: parseFloat(lng) };
    // console.log("Origin coordinates:", origin); //DEBUG log
    // console.log("Destination coordinates:", destination); //DEBUG log

    const request = {
        origin: origin,
        destination: destination,
        travelMode: google.maps.TravelMode.DRIVING,
    };

    directionsService.route(request, (result, status) => {
        if (status === google.maps.DirectionsStatus.OK) {
            // console.log("Directions response:", result); //DEBUG log
            directionsRenderer.setDirections(result);
        } else {
            console.error("Directions request failed:", status);
            alert("Could not calculate directions. Try again.");
        }
    });
}


function displayActivities(activities) {
    document.getElementById("activities").style.display = "block";
    const activityList = document.querySelector("#activity");
    activityList.innerHTML = '';

    activities.forEach(activity => {
        const listItem = document.createElement('li');
        const mapLink = document.createElement('a');
        mapLink.href = "#";
        mapLink.textContent = `${activity.activity} at ${activity.place}`;
        mapLink.onclick = (e) => {
            e.preventDefault();
            // console.log("Searching for place:", activity.place); // Debug log
            searchPlace(activity.place);
            selectedActivity = activity; // Store clicked activity
            document.getElementById("newSuggestionBtn").style.display = "block"; // Show button
        };
       

        listItem.appendChild(mapLink);
        // listItem.appendChild(openingHoursDiv);
        activityList.appendChild(listItem);
    });
}

// Function to get CSRF token for Django
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        let cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            let cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showError(error) {
    switch (error.code) {
        case error.PERMISSION_DENIED:
            document.getElementById("status").innerHTML = "User denied the request for Geolocation.";
            break;
        case error.POSITION_UNAVAILABLE:
            document.getElementById("status").innerHTML = "Location information is unavailable.";
            break;
        case error.TIMEOUT:
            document.getElementById("status").innerHTML = "The request to get user location timed out.";
            break;
        case error.UNKNOWN_ERROR:
            document.getElementById("status").innerHTML = "An unknown error occurred.";
            break;
    }
}

function updateWeatherDisplay(temperature, description) {
    const backgrounds = {
        'clear': 'linear-gradient(135deg, #00BFFF, #1E90FF)',
        'clouds': 'linear-gradient(135deg, #A9A9A9, #708090)',
        'rain': 'linear-gradient(135deg, #4682B4, #1E4E8C)',
        'snow': 'linear-gradient(135deg, #F0F8FF, #87CEFA)',
        'thunderstorm': 'linear-gradient(135deg, #483D8B, #000000)'
    };

    const tempClass = temperature > 25 ? 'hot' : 
                      temperature < 10 ? 'cold' : 'moderate';

    const backgroundKey = Object.keys(backgrounds).find(key => 
        description.toLowerCase().includes(key)
    ) || 'clear';

    return {
        background: backgrounds[backgroundKey],
        tempClass: tempClass
    };
}

function updateWeather(weather) {
    const weatherBox = document.getElementById("weather");
    const { background, tempClass } = updateWeatherDisplay(
        weather.temperature, 
        weather.description
    );

    weatherBox.style.background = background;
    weatherBox.classList.add(tempClass);
}
</script>

</body>
</html>
